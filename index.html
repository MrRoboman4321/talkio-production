<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.js"></script>
<script>
$(document).ready(function() {
  var socket = io();

  // variables 
var leftchannel = [];
var rightchannel = [];
var recorder = null;
var recording = false;
var recordingLength = 0;
var volume = null;
var audioInput = null;
var sampleRate = null;
var audioContext = null;
var context = null;
var outputElement = document.getElementById('output');
var outputString;
var blob = null;

// feature detection 
if (!navigator.getUserMedia)
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                  navigator.mozGetUserMedia || navigator.msGetUserMedia;

if (navigator.getUserMedia){
    navigator.getUserMedia({audio:true}, success, function(e) {
    alert('Error capturing audio.');
    });
} else alert('getUserMedia not supported in this browser.');

// when key is down

    
    // if R is pressed, we start recording
    $('button#record').click(function() {
    	console.log("Record pressed");
        recording = true;
        // reset the buffers for the new recording
        leftchannel.length = rightchannel.length = 0;
        recordingLength = 0;
    });
    $('button#stop').click(function() {
        
        // we stop recording
        recording = false;

        // we flat the left and right channels down
        var leftBuffer = mergeBuffers ( leftchannel, recordingLength );
        var rightBuffer = mergeBuffers ( rightchannel, recordingLength );
        // we interleave both channels together
        var interleaved = interleave ( leftBuffer, rightBuffer );
        
        // we create our wav file
        var buffer = new ArrayBuffer(44 + interleaved.length * 2);
        var view = new DataView(buffer);
        
        // RIFF chunk descriptor
        writeUTFBytes(view, 0, 'RIFF');
        view.setUint32(4, 44 + interleaved.length * 2, true);
        writeUTFBytes(view, 8, 'WAVE');
        // FMT sub-chunk
        writeUTFBytes(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        // stereo (2 channels)
        view.setUint16(22, 2, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 4, true);
        view.setUint16(32, 4, true);
        view.setUint16(34, 16, true);
        // data sub-chunk
        writeUTFBytes(view, 36, 'data');
        view.setUint32(40, interleaved.length * 2, true);
        
        // write the PCM samples
        var lng = interleaved.length;
        var index = 44;
        var volume = 1;
        for (var i = 0; i < lng; i++){
            view.setInt16(index, interleaved[i] * (0x7FFF * volume), true);
            index += 2;
        }
        
        // our final binary blob
        blob = new Blob ( [ view ], { type : 'audio/wav' } );
        

        var url = (window.URL || window.webkitURL).createObjectURL(blob);
        document.getElementById('blobSource').src = url;
        document.getElementById('audioControl').load()
        document.getElementById('audioControl').play()
        console.log(blob);
    });


function interleave(leftChannel, rightChannel){
  var length = leftChannel.length + rightChannel.length;
  var result = new Float32Array(length);

  var inputIndex = 0;

  for (var index = 0; index < length; ){
    result[index++] = leftChannel[inputIndex];
    result[index++] = rightChannel[inputIndex];
    inputIndex++;
  }
  return result;
}

function mergeBuffers(channelBuffer, recordingLength){
  var result = new Float32Array(recordingLength);
  var offset = 0;
  var lng = channelBuffer.length;
  for (var i = 0; i < lng; i++){
    var buffer = channelBuffer[i];
    result.set(buffer, offset);
    offset += buffer.length;
  }
  return result;
}

function writeUTFBytes(view, offset, string){ 
  var lng = string.length;
  for (var i = 0; i < lng; i++){
    view.setUint8(offset + i, string.charCodeAt(i));
  }
}

function success(e){
    // creates the audio context
    audioContext = window.AudioContext || window.webkitAudioContext;
    context = new audioContext();

	// we query the context sample rate (varies depending on platforms)
    sampleRate = context.sampleRate;

    console.log('succcess');
    
    // creates a gain node
    volume = context.createGain();

    // creates an audio node from the microphone incoming stream
    audioInput = context.createMediaStreamSource(e);

    // connect the stream to the gain node
    audioInput.connect(volume);

    /* From the spec: This value controls how frequently the audioprocess event is 
    dispatched and how many sample-frames need to be processed each call. 
    Lower values for buffer size will result in a lower (better) latency. 
    Higher values will be necessary to avoid audio breakup and glitches */
    var bufferSize = 2048;
    recorder = context.createScriptProcessor(bufferSize, 2, 2);

    recorder.onaudioprocess = function(e){
        if (!recording) return;
        var left = e.inputBuffer.getChannelData (0);
        var right = e.inputBuffer.getChannelData (1);
        // we clone the samples
        leftchannel.push (new Float32Array (left));
        rightchannel.push (new Float32Array (right));
        recordingLength += bufferSize;
        console.log('recording');
    }

    // we connect the recorder
    volume.connect (recorder);
    recorder.connect (context.destination); 
}

$('button#send').click(function() {
	console.log("Swag emit");
	socket.emit('blob', {blob: blob});
});

socket.on('getUsername', function() {
    username = prompt("Username plz");
    socket.emit('username', {username: username});
});

function toArrayBuffer(buffer) {
    var ab = new ArrayBuffer(buffer.length);
    var view = new Uint8Array(ab);
    for (var i = 0; i < buffer.length; ++i) {
        view[i] = buffer[i];
    }
    return ab;
}

socket.on('play', function(data) {
	console.log(data.blob);
	data.blob = new Blob([data.blob], { type : 'audio/wav' });
	console.log(data.blob);
	var url = (window.URL || window.webkitURL).createObjectURL(data.blob);
    document.getElementById('blobSource').src = url;
    document.getElementById('audioControl').load()
    document.getElementById('audioControl').play()
})

});
</script>
<!--====================HTML====================!-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="css" href="stylesheet.css">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>
</head>
  <body>
    <div class="container-fluid">
<!--====================HEADER====================!-->
        <!--<div class='col-md-12' id='header'>
            <h1 class='jumbotron' id='title'>talkio</h1>
        </div>!-->
        <div id='header'>
            <h1 class='col-md-3' id='title'>talkio</h1>
<!--====================HELP====================!-->
            <div class='col-md-8'></div> <!--blank div to take up middle of header!-->
            <div class='col-md-1' id='helpDiv'>
                <button type="button" class="btn btn-primary btn-m btn-block" id='helpButton' data-toggle="modal" data-target="#loginModal"><span title='Login' class='glyphicon glyphicon-log-in'></span></button>
                <button type="button" class="btn btn-primary btn-m btn-block" id='helpButton' data-toggle="modal" data-target="#helpModal"><span title='Help' class='glyphicon glyphicon-question-sign'></span></button>
                <button type="button" class="btn btn-primary btn-m btn-block" id='helpButton' data-toggle="modal" data-target="#shareModal"><span title='Share' class='glyphicon glyphicon-share'></span></button>
            </div>
        </div>    

<!--Login Modal!-->
        <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Login</h4>
                    </div>
                    <div class="modal-body">
                        ...
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary">Login</button>
                    </div>
                </div>
            </div>
        </div>
<!--Help Modal!-->
        <div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Help</h4>
                    </div>
                    <div class="modal-body">
                        ...
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
                    </div>
                </div>
            </div>
        </div>
<!--Share Modal!-->
        <div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Share</h4>
                    </div>
                    <div class="modal-body">
                        ...
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
                    </div>
                </div>
            </div>
        </div>
<!--====================BUTTONS====================!-->
            <div class="btn-group-vertical col-md-8" id='mainBtns' role="group" aria-label="...">
                <button title='Record' class="btn btn-default btn-lg " id='record'><span class='glyphicon glyphicon-bullhorn'></span></button>
                <button title='Stop' class="btn btn-default btn-lg" id='stop'><span class='glyphicon glyphicon-stop'></span></button>
                <button title='Review' class="btn btn-default btn-lg" id="review"><span class='glyphicon glyphicon-headphones'></span></button>
                <button title='Send' class="btn btn-default btn-lg" id="send"><span class='glyphicon glyphicon-send'></span></button>
            </div>
<!--====================USER FEED====================!-->
            <div class='col-md-2'>
                <ul class='list-group' id='userFeed'>
                    <lh class='list-group-item'><b>Online</b></lh>
                </ul>
            </div>
            <div class='col-md-2'>
                <ul class='list-group' id='userFeed'>
                    <lh class='list-group-item'><b>Recording</b></lh>
                </ul>
            </div>
        </div>
        <audio id='audioControl'>
            <source src='' id='blobSource' type='audio/mp3'></source>
        </audio>
    </body>
</html>